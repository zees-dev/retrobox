<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Game Menu Web Component</title>
</head>
<body>
    <script type="module">
        // Game Menu Web Component - Dynamic Preset Loading
        class GameMenuElement extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });

                this._mode = 'screen';
                this._showManualConfig = true;
                this._ws = null;
                this._currentRomSource = null;
                this._currentParentRomSource = null;
                this._currentBiosSource = null;
                this._currentGameHeight = '';
                this.gamePresets = {};

                this.shadowRoot.innerHTML = this.getTemplate();

                this.container = this.shadowRoot.querySelector('.game-controls');
                this.allGamesSelect = this.shadowRoot.getElementById('allGamesSelect');
                this.coreSelect = this.shadowRoot.getElementById('coreSelect');
                this.playerCountSelect = this.shadowRoot.getElementById('playerCountSelect');
                this.gameSelect = this.shadowRoot.getElementById('gameSelect');
                this.romUrlInput = this.shadowRoot.getElementById('romUrlInput');
                this.biosUrlInput = this.shadowRoot.getElementById('biosUrlInput');
                this.consoleSelect = this.shadowRoot.getElementById('consoleSelect');
                this.startButton = this.shadowRoot.getElementById('startButton');
                this.uploadButton = this.shadowRoot.getElementById('uploadButton');
                this.biosUploadButton = this.shadowRoot.getElementById('biosUploadButton');
                this.fileInput = this.shadowRoot.getElementById('fileInput');
                this.biosFileInput = this.shadowRoot.getElementById('biosFileInput');
                this.loadingOverlay = this.shadowRoot.getElementById('loadingOverlay');
                this.cancelButton = this.shadowRoot.getElementById('cancelButton');
                this.gameHeightSelect = this.shadowRoot.getElementById('gameHeightSelect');
                this.refreshButton = this.shadowRoot.getElementById('refreshButton');
            }

            connectedCallback() { this.init(); }

            static get observedAttributes() { return ['mode', 'show-manual-config']; }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name === 'mode') this._mode = newValue || 'screen';
                else if (name === 'show-manual-config') {
                    this._showManualConfig = newValue !== 'false';
                    this.updateManualConfigVisibility();
                }
            }

            get mode() { return this._mode; }
            set mode(v) { this._mode = v; this.setAttribute('mode', v); }

            getTemplate() {
                return `
                    <style>
                        :host {
                            display: block;
                            position: fixed;
                            inset: 0;
                            z-index: 1000;
                            pointer-events: none;
                        }
                        .game-controls {
                            position: fixed;
                            top: 50%; left: 50%;
                            transform: translate(-50%, -50%);
                            display: grid;
                            grid-template-columns: 1fr 40px;
                            gap: 10px;
                            background: rgba(0, 0, 0, 0.8);
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            transition: opacity 0.3s, visibility 0.3s;
                            width: max(350px, 25vw);
                            max-width: 90vw;
                            box-sizing: border-box;
                            pointer-events: auto;
                        }
                        .game-controls.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
                        .game-controls.preset-only { width: max(300px, 25vw); padding: 20px; }

                        @media (orientation: landscape) and (max-height: 600px) {
                            .game-controls { max-height: 85vh; overflow-y: auto; width: max(350px, 30vw); max-width: 70vw; }
                            .game-controls.preset-only { width: max(280px, 25vw); }
                            input, select { height: 40px !important; font-size: 14px !important; }
                            .upload-btn { width: 40px !important; height: 40px !important; }
                            .start-button.full-width { height: 50px !important; font-size: 16px !important; margin-top: 10px !important; }
                        }

                        input[type="text"], select {
                            width: 100%; height: 40px; padding: 0 12px;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            border-radius: 6px; color: #fff;
                            font-family: monospace; font-size: 14px;
                            transition: all 0.3s; box-sizing: border-box;
                        }
                        input[type="text"]:focus { outline: none; border-color: #1AAFFF; background: rgba(255, 255, 255, 0.15); }
                        input[type="text"]::placeholder { color: rgba(255, 255, 255, 0.5); }

                        select {
                            cursor: pointer; appearance: none;
                            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                            background-repeat: no-repeat;
                            background-position: right 10px center;
                            background-size: 20px; padding-right: 40px;
                        }
                        select:disabled { background: rgba(128, 128, 128, 0.1); border-color: rgba(128, 128, 128, 0.2); color: #666; cursor: not-allowed; }
                        select:not(:disabled):hover { border-color: #1AAFFF; background-color: rgba(255, 255, 255, 0.15); }
                        select option { background: #333; color: #fff; font-size: 16px; }
                        @supports (-webkit-touch-callout: none) { select { font-size: 16px; } }

                        .filter-row {
                            grid-column: 1 / -1;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 10px;
                        }

                        .upload-btn, .start-button {
                            width: 40px; height: 40px; border-radius: 6px;
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            background: rgba(255, 255, 255, 0.1); color: #fff;
                            font-size: 20px; cursor: pointer; transition: all 0.3s;
                            display: flex; align-items: center; justify-content: center;
                            padding: 0; flex-shrink: 0;
                        }
                        .upload-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); border-color: #1AAFFF; transform: scale(1.05); }

                        .start-button { background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); color: #4CAF50; font-weight: bold; }
                        .start-button.full-width { width: 100%; height: 45px; font-size: 16px; margin-top: 5px; }
                        .start-button:not(:disabled):hover { background: rgba(76, 175, 80, 0.3); border-color: #4CAF50; color: #66BB6A; transform: scale(1.05); }
                        .start-button:disabled { background: rgba(128, 128, 128, 0.1); border-color: rgba(128, 128, 128, 0.2); color: #666; opacity: 0.6; cursor: not-allowed; }

                        .full-width { grid-column: 1 / -1; }
                        .or-separator { grid-column: 1 / -1; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px; padding: 5px 0; }
                        input[type="file"] { display: none; }
                        .connection-status { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); color: #ff9800; font-size: 14px; white-space: nowrap; }
                        .disabled-overlay { opacity: 0.5; }

                        .loading-overlay {
                            position: absolute; inset: 0;
                            background: rgba(0, 0, 0, 0.9);
                            display: none; align-items: center; justify-content: center;
                            flex-direction: column; border-radius: 8px; z-index: 10;
                        }
                        .loading-overlay.active { display: flex; }
                        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
                        @keyframes spin { to { transform: rotate(360deg); } }
                        .loading-text { color: #fff; margin-top: 20px; font-size: 16px; }
                        .cancel-button {
                            margin-top: 20px; padding: 10px 24px;
                            background: rgba(244, 67, 54, 0.2); border: 2px solid rgba(244, 67, 54, 0.4);
                            border-radius: 6px; color: #f44336; font-size: 14px; cursor: pointer;
                            transition: all 0.3s;
                        }
                        .cancel-button:hover { background: rgba(244, 67, 54, 0.3); border-color: #f44336; }

                        .refresh-button {
                            position: fixed;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border-radius: 6px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            color: rgba(255, 255, 255, 0.3);
                            cursor: pointer;
                            display: none;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s;
                            z-index: 100;
                            pointer-events: auto;
                        }
                        .refresh-button:hover {
                            background: rgba(255, 255, 255, 0.1);
                            border-color: rgba(255, 255, 255, 0.2);
                            color: rgba(255, 255, 255, 0.6);
                        }
                        .refresh-button svg {
                            width: 18px;
                            height: 18px;
                            fill: currentColor;
                        }
                        :host([mode="controller"]) .refresh-button { display: flex; }
                    </style>

                    <div class="game-controls" id="gameControls">
                        <select id="allGamesSelect" class="full-width"><option value="">All Games</option></select>
                        <div class="or-separator">- or filter by -</div>
                        <div class="filter-row">
                            <select id="coreSelect"><option value="">Console</option></select>
                            <select id="playerCountSelect" disabled><option value="">Players</option></select>
                        </div>
                        <select id="gameSelect" class="full-width" disabled><option value="">Select Game</option></select>
                        <div class="or-separator">- or -</div>
                        <input type="text" id="romUrlInput" placeholder="Enter ROM URL or upload file">
                        <button class="upload-btn" id="uploadButton">+</button>
                        <input type="text" id="biosUrlInput" placeholder="BIOS URL (optional)">
                        <button class="upload-btn" id="biosUploadButton">+</button>
                        <select id="consoleSelect" class="full-width"><option value="">Select Console</option></select>
                        <select id="gameHeightSelect" class="full-width">
                            <option value="">Game Height: 100%</option>
                            <option value="90">90%</option>
                            <option value="75">75%</option>
                            <option value="60">60%</option>
                        </select>
                        <button class="start-button full-width" id="startButton" disabled>Start Game</button>
                        <div class="loading-overlay" id="loadingOverlay">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading game...</div>
                            <button class="cancel-button" id="cancelButton">Cancel</button>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".zip,.7z,.nes,.smc,.sfc,.gb,.gba,.gbc,.n64,.z64,.nds,.pce,.ngp,.ngc,.ws,.wsc,.col,.cv,.d64">
                    <input type="file" id="biosFileInput" accept=".zip,.7z,.bin,.rom,.bios">
                    <button class="refresh-button" id="refreshButton" title="Refresh Screen & Controller">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </button>
                `;
            }

            async init() {
                // Core display names
                this.coreNames = {
                    psx: 'PlayStation',
                    snes: 'SNES',
                    arcade: 'Arcade',
                    n64: 'Nintendo 64',
                    segaMD: 'Sega MD',
                    nes: 'NES',
                    gb: 'Game Boy',
                    gba: 'GBA',
                    nds: 'Nintendo DS',
                };

                // All core values for manual console selection
                this.coreValues = {
                    "Nintendo 64": "n64", "Nintendo Game Boy": "gb", "Nintendo Game Boy Advance": "gba",
                    "Nintendo DS": "nds", "Nintendo Entertainment System": "nes", "Super Nintendo Entertainment System": "snes",
                    "PlayStation": "psx", "Virtual Boy": "vb", "Sega Mega Drive": "segaMD", "Sega Master System": "segaMS",
                    "Sega CD": "segaCD", "Atari Lynx": "lynx", "Sega 32X": "sega32x", "Atari Jaguar": "jaguar",
                    "Sega Game Gear": "segaGG", "Sega Saturn": "segaSaturn", "Atari 7800": "atari7800", "Atari 2600": "atari2600",
                    "Arcade": "arcade", "NEC TurboGrafx-16/SuperGrafx/PC Engine": "pce", "NEC PC-FX": "pcfx",
                    "SNK NeoGeo Pocket (Color)": "ngp", "Bandai WonderSwan (Color)": "ws", "ColecoVision": "coleco",
                    "Commodore 64": "vice_x64sc", "Commodore 128": "vice_x128", "Commodore VIC20": "vice_xvic",
                    "Commodore Plus/4": "vice_xplus4", "Commodore PET": "vice_xpet", "DOSBOX-PURE": "dosbox_pure"
                };

                // Fetch presets from API
                await this.loadPresets();

                this.populateSelectors();
                this.setupEventListeners();
                this.updateManualConfigVisibility();
                this.updateConnectionStatus();

                // Set default selection if presets loaded
                if (Object.keys(this.gamePresets).length > 0) {
                    const firstCore = Object.keys(this.gamePresets)[0];
                    this.coreSelect.value = firstCore;
                    this.updatePlayerCountOptions();
                    const firstPlayerCount = Object.keys(this.gamePresets[firstCore] || {})[0];
                    if (firstPlayerCount) {
                        this.playerCountSelect.value = firstPlayerCount;
                        this.updateGameOptions();
                        const firstGame = this.gamePresets[firstCore]?.[firstPlayerCount]?.[0];
                        if (firstGame) {
                            this.gameSelect.value = firstGame.rom;
                            this.applySelectedGame();
                        }
                    }
                }
            }

            async loadPresets() {
                try {
                    const res = await fetch('/api/presets');
                    if (res.ok) {
                        this.gamePresets = await res.json();
                    }
                } catch (err) {
                    console.error('Failed to load presets:', err);
                    this.gamePresets = {};
                }
            }

            populateSelectors() {
                // Populate "All Games" dropdown with optgroups: "Core - Xp"
                const grouped = {};
                for (const [core, playerCounts] of Object.entries(this.gamePresets)) {
                    // Sort player counts descending
                    const sortedPCs = Object.keys(playerCounts).sort((a, b) => parseInt(b) - parseInt(a));
                    for (const pc of sortedPCs) {
                        const groupKey = `${core}|${pc}`;
                        grouped[groupKey] = playerCounts[pc]
                            .map(game => ({ ...game, core, playerCount: pc }))
                            .sort((a, b) => a.name.localeCompare(b.name));
                    }
                }
                // Sort group keys by core display name, then player count descending
                const sortedGroups = Object.keys(grouped).sort((a, b) => {
                    const [coreA, pcA] = a.split('|');
                    const [coreB, pcB] = b.split('|');
                    const coreCompare = (this.coreNames[coreA] || coreA).localeCompare(this.coreNames[coreB] || coreB);
                    if (coreCompare !== 0) return coreCompare;
                    return parseInt(pcB) - parseInt(pcA);
                });
                for (const groupKey of sortedGroups) {
                    const [core, pc] = groupKey.split('|');
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${this.coreNames[core] || core} - ${pc}`;
                    for (const game of grouped[groupKey]) {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ rom: game.rom, core: game.core, playerCount: game.playerCount });
                        opt.textContent = game.name;
                        optgroup.appendChild(opt);
                    }
                    this.allGamesSelect.appendChild(optgroup);
                }

                // Populate core dropdown with cores that have presets
                for (const core of Object.keys(this.gamePresets)) {
                    const opt = document.createElement('option');
                    opt.value = core;
                    opt.textContent = this.coreNames[core] || core;
                    this.coreSelect.appendChild(opt);
                }

                // Populate full console list for manual selection
                for (const [name, core] of Object.entries(this.coreValues)) {
                    const opt = document.createElement('option');
                    opt.value = core;
                    opt.textContent = name;
                    this.consoleSelect.appendChild(opt);
                }
            }

            updatePlayerCountOptions() {
                const core = this.coreSelect.value;
                this.playerCountSelect.innerHTML = '<option value="">Players</option>';

                if (core && this.gamePresets[core]) {
                    const playerCounts = Object.keys(this.gamePresets[core]).sort((a, b) => {
                        return parseInt(b) - parseInt(a); // Sort descending (8p, 5p, 4p, 3p, 2p)
                    });
                    for (const pc of playerCounts) {
                        const opt = document.createElement('option');
                        opt.value = pc;
                        opt.textContent = pc;
                        this.playerCountSelect.appendChild(opt);
                    }
                    this.playerCountSelect.disabled = false;
                } else {
                    this.playerCountSelect.disabled = true;
                }

                this.gameSelect.innerHTML = '<option value="">Select Game</option>';
                this.gameSelect.disabled = true;
            }

            updateGameOptions() {
                const core = this.coreSelect.value;
                const playerCount = this.playerCountSelect.value;
                this.gameSelect.innerHTML = '<option value="">Select Game</option>';

                if (core && playerCount && this.gamePresets[core]?.[playerCount]) {
                    const games = this.gamePresets[core][playerCount];
                    for (const game of games) {
                        const opt = document.createElement('option');
                        opt.value = game.rom;
                        opt.textContent = game.name;
                        this.gameSelect.appendChild(opt);
                    }
                    this.gameSelect.disabled = false;
                } else {
                    this.gameSelect.disabled = true;
                }
            }

            setupEventListeners() {
                this.allGamesSelect.onchange = () => {
                    if (this.allGamesSelect.value) {
                        const { rom, core, playerCount } = JSON.parse(this.allGamesSelect.value);
                        // Update filtered dropdowns to match
                        this.coreSelect.value = core;
                        this.updatePlayerCountOptions();
                        this.playerCountSelect.value = playerCount;
                        this.updateGameOptions();
                        this.gameSelect.value = rom;
                        this.applySelectedGame();
                    } else {
                        this.clearManualInputs();
                    }
                    this.updateStartButtonState();
                };

                this.coreSelect.onchange = () => {
                    this.allGamesSelect.value = '';
                    this.updatePlayerCountOptions();
                    this.clearManualInputs();
                    this.updateStartButtonState();
                };

                this.playerCountSelect.onchange = () => {
                    this.allGamesSelect.value = '';
                    this.updateGameOptions();
                    this.clearManualInputs();
                    this.updateStartButtonState();
                };

                this.gameSelect.onchange = () => {
                    if (this.gameSelect.value) {
                        this.allGamesSelect.value = '';
                        this.applySelectedGame();
                    } else {
                        this._currentRomSource = this._currentParentRomSource = this._currentBiosSource = null;
                        this.romUrlInput.value = this.biosUrlInput.value = '';
                    }
                    this.updateStartButtonState();
                };

                this.uploadButton.onclick = () => this.fileInput.click();
                this.biosUploadButton.onclick = () => this.biosFileInput.click();

                this.fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    this._currentRomSource = file;
                    this._currentParentRomSource = null;
                    this._currentBiosSource = null;
                    this.romUrlInput.value = file.name;
                    this.biosUrlInput.value = '';
                    this.allGamesSelect.value = '';
                    this.coreSelect.value = '';
                    this.playerCountSelect.value = '';
                    this.playerCountSelect.disabled = true;
                    this.gameSelect.value = '';
                    this.gameSelect.disabled = true;
                    this.consoleSelect.value = '';
                    this.startButton.disabled = true;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const core = this.detectCore(ext);
                    if (core) {
                        this.consoleSelect.value = core;
                        this.updateStartButtonState();
                    }
                };

                this.biosFileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this._currentBiosSource = file;
                        this.biosUrlInput.value = file.name;
                    }
                };

                this.romUrlInput.oninput = (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        this._currentRomSource = url;
                        this._currentParentRomSource = null;
                        this._currentBiosSource = null;
                        this.biosUrlInput.value = '';
                        this.allGamesSelect.value = '';
                        this.coreSelect.value = '';
                        this.playerCountSelect.value = '';
                        this.playerCountSelect.disabled = true;
                        this.gameSelect.value = '';
                        this.gameSelect.disabled = true;
                        const ext = url.split('/').pop().split('?')[0].split('.').pop().toLowerCase();
                        const core = this.detectCore(ext);
                        if (core) this.consoleSelect.value = core;
                        this.consoleSelect.disabled = false;
                    } else {
                        this._currentRomSource = null;
                        this.consoleSelect.disabled = true;
                    }
                    this.updateStartButtonState();
                };

                this.biosUrlInput.oninput = (e) => {
                    this._currentBiosSource = e.target.value.trim() || null;
                };

                this.consoleSelect.onchange = () => this.updateStartButtonState();

                this.gameHeightSelect.onchange = (e) => {
                    this._currentGameHeight = e.target.value;
                };

                this.startButton.onclick = () => {
                    if (!this._currentRomSource || !this.consoleSelect.value) return;

                    const romName = typeof this._currentRomSource === 'string'
                        ? this._currentRomSource.split('/').pop().split('?')[0]
                        : this._currentRomSource.name;

                    const gameData = {
                        romSource: this._currentRomSource,
                        parentRomSource: this._currentParentRomSource,
                        biosSource: this._currentBiosSource,
                        core: this.consoleSelect.value,
                        romName,
                        gameHeight: this._currentGameHeight || null
                    };

                    this.showLoading();

                    if (this._mode === 'controller' && this._ws?.readyState === WebSocket.OPEN) {
                        if (this._currentRomSource instanceof File || this._currentBiosSource instanceof File) {
                            alert('File uploads not supported in controller mode. Use URLs or presets.');
                            this.hideLoading();
                            return;
                        }
                        this._ws.send(JSON.stringify({ type: 'startGame', gameData }));
                    } else {
                        this.dispatchEvent(new CustomEvent('gamestart', { detail: gameData, bubbles: true }));
                    }
                };

                this.cancelButton.onclick = () => {
                    if (this._mode === 'controller' && this._ws?.readyState === WebSocket.OPEN) {
                        this._ws.send(JSON.stringify({ type: 'resetToMenu' }));
                    } else {
                        this.dispatchEvent(new CustomEvent('resetToMenu', { bubbles: true }));
                    }
                    this.hideLoading();
                };

                this.refreshButton.onclick = () => {
                    if (this._ws?.readyState === WebSocket.OPEN) {
                        this._ws.send(JSON.stringify({ type: 'hardRefresh' }));
                    }
                    setTimeout(() => window.location.reload(), 500);
                };
            }

            clearManualInputs() {
                this.romUrlInput.value = '';
                this.biosUrlInput.value = '';
                this._currentRomSource = null;
                this._currentParentRomSource = null;
                this._currentBiosSource = null;
            }

            applySelectedGame() {
                const core = this.coreSelect.value;
                const playerCount = this.playerCountSelect.value;
                const romPath = this.gameSelect.value;

                if (!core || !playerCount || !romPath) return;

                const games = this.gamePresets[core]?.[playerCount];
                const game = games?.find(g => g.rom === romPath);
                if (!game) return;

                this.romUrlInput.value = game.rom;
                this.biosUrlInput.value = game.bios || '';
                this._currentRomSource = game.rom;
                this._currentParentRomSource = game.parentRom || null;
                this._currentBiosSource = game.bios || null;
                this.consoleSelect.value = core;
                this.updateStartButtonState();
            }

            updateManualConfigVisibility() {
                if (!this.container) return;
                if (!this._showManualConfig) {
                    this.container.classList.add('preset-only');
                    // Hide all or-separators except the first one (filter by)
                    const separators = this.shadowRoot.querySelectorAll('.or-separator');
                    separators.forEach((sep, i) => { if (i > 0) sep.style.display = 'none'; });
                    this.romUrlInput.style.display = 'none';
                    this.uploadButton.style.display = 'none';
                    this.biosUrlInput.style.display = 'none';
                    this.biosUploadButton.style.display = 'none';
                    this.consoleSelect.style.display = 'none';
                    this.container.style.gridTemplateColumns = '1fr';
                } else if (this._mode === 'controller') {
                    this.uploadButton.style.display = 'none';
                    this.biosUploadButton.style.display = 'none';
                    this.romUrlInput.placeholder = 'Enter ROM URL';
                    this.biosUrlInput.placeholder = 'BIOS URL (optional)';
                }
            }

            updateStartButtonState() {
                const hasRom = !!this._currentRomSource;
                const hasCore = !!this.consoleSelect.value;
                const connected = this._mode !== 'controller' || this._ws?.readyState === WebSocket.OPEN;
                this.startButton.disabled = !hasRom || !hasCore || !connected;
            }

            detectCore(ext) {
                const map = {
                    nes: 'nes', fds: 'nes', unif: 'nes', unf: 'nes',
                    smc: 'snes', fig: 'snes', sfc: 'snes', gd3: 'snes', gd7: 'snes', dx2: 'snes', bsx: 'snes', swc: 'snes',
                    z64: 'n64', n64: 'n64', pce: 'pce', ngp: 'ngp', ngc: 'ngp',
                    ws: 'ws', wsc: 'ws', col: 'coleco', cv: 'coleco', d64: 'vice_x64sc',
                    nds: 'nds', gba: 'gba', gb: 'gb'
                };
                return map[ext] || null;
            }

            hide() { this.container.classList.add('hidden'); this.hideLoading(); }
            show() { this.container.classList.remove('hidden'); this.hideLoading(); }
            showLoading() { this.loadingOverlay?.classList.add('active'); }
            hideLoading() { this.loadingOverlay?.classList.remove('active'); }
            setLoadingText(text) {
                const el = this.shadowRoot.querySelector('.loading-text');
                if (el) el.textContent = text;
            }
            setWebSocket(ws) { this._ws = ws; this.updateConnectionStatus(); }
            setPeerConnection(conn) { this.setWebSocket(conn); }

            updateConnectionStatus() {
                if (this._mode !== 'controller') return;
                const connected = this._ws?.readyState === WebSocket.OPEN;
                this.coreSelect.disabled = !connected;
                this.playerCountSelect.disabled = !connected;
                this.gameSelect.disabled = !connected;
                this.romUrlInput.disabled = !connected;
                this.biosUrlInput.disabled = !connected;
                this.consoleSelect.disabled = !connected;
                this.gameHeightSelect.disabled = !connected;
                this.updateStartButtonState();

                if (!connected) {
                    this.container.classList.add('disabled-overlay');
                    let msg = this.shadowRoot.querySelector('.connection-status');
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'connection-status';
                        msg.textContent = 'Waiting for connection to screen...';
                        this.container.appendChild(msg);
                    }
                } else {
                    this.container.classList.remove('disabled-overlay');
                    this.shadowRoot.querySelector('.connection-status')?.remove();
                }
            }
        }

        customElements.define('game-menu', GameMenuElement);
    </script>
</body>
</html>
