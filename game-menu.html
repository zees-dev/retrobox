<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <title>Game Menu Web Component</title>
</head>
<body>
    <script type="module">
        // Game Menu Web Component - Dynamic Preset Loading
        class GameMenuElement extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });

                this._mode = 'screen';
                this._ws = null;
                this._currentRomSource = null;
                this._currentParentRomSource = null;
                this._currentBiosSource = null;
                this._currentGameHeight = 100;
                this._threads = false;
                this._useUrl = false;
                this._debugMode = false;
                this._showingSettings = false;
                this.gamePresets = {};

                this.shadowRoot.innerHTML = this.getTemplate();

                this.container = this.shadowRoot.querySelector('.game-controls');
                this.allGamesSelect = this.shadowRoot.getElementById('allGamesSelect');
                this.coreSelect = this.shadowRoot.getElementById('coreSelect');
                this.playerCountSelect = this.shadowRoot.getElementById('playerCountSelect');
                this.gameSelect = this.shadowRoot.getElementById('gameSelect');
                this.romUrlInput = this.shadowRoot.getElementById('romUrlInput');
                this.biosUrlInput = this.shadowRoot.getElementById('biosUrlInput');
                this.consoleSelect = this.shadowRoot.getElementById('consoleSelect');
                this.startButton = this.shadowRoot.getElementById('startButton');
                this.uploadButton = this.shadowRoot.getElementById('uploadButton');
                this.biosUploadButton = this.shadowRoot.getElementById('biosUploadButton');
                this.fileInput = this.shadowRoot.getElementById('fileInput');
                this.biosFileInput = this.shadowRoot.getElementById('biosFileInput');
                this.loadingOverlay = this.shadowRoot.getElementById('loadingOverlay');
                this.cancelButton = this.shadowRoot.getElementById('cancelButton');
                this.refreshButton = this.shadowRoot.getElementById('refreshButton');
                this.debugButton = this.shadowRoot.getElementById('debugButton');
                this.gameSelectionView = this.shadowRoot.getElementById('gameSelectionView');
                this.settingsView = this.shadowRoot.getElementById('settingsView');
                this.playerStatus = this.shadowRoot.getElementById('playerStatus');
                this.playerIndicators = this.shadowRoot.querySelectorAll('.player-indicator');
                this.gameHeightSlider = this.shadowRoot.getElementById('gameHeightSlider');
                this.gameHeightValue = this.shadowRoot.getElementById('gameHeightValue');
                this.threadsToggle = this.shadowRoot.getElementById('threadsToggle');
                this.useUrlToggle = this.shadowRoot.getElementById('useUrlToggle');
                this.debugModeToggle = this.shadowRoot.getElementById('debugModeToggle');
                this.manualConfigSection = this.shadowRoot.getElementById('manualConfigSection');
                this.presetSection = this.shadowRoot.getElementById('presetSection');
                this.menuTitle = this.shadowRoot.querySelector('.menu-title');

                // Remove cursor after typewriter animation
                this.menuTitle?.addEventListener('animationend', (e) => {
                    if (e.animationName === 'typewriter') {
                        this.menuTitle.classList.add('typed');
                    }
                });
            }

            connectedCallback() { this.init(); }

            static get observedAttributes() { return ['mode']; }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name === 'mode') this._mode = newValue || 'screen';
            }

            get mode() { return this._mode; }
            set mode(v) { this._mode = v; this.setAttribute('mode', v); }

            getTemplate() {
                return `
                    <style>
                        :host {
                            display: block;
                            position: fixed;
                            inset: 0;
                            z-index: 1000;
                            pointer-events: none;
                        }
                        .game-controls {
                            position: fixed;
                            top: 50%; left: 50%;
                            transform: translate(-50%, -50%);
                            display: grid;
                            grid-template-columns: 1fr 40px;
                            gap: 10px;
                            background: rgba(0, 0, 0, 0.8);
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            transition: opacity 0.3s, visibility 0.3s;
                            width: max(350px, 25vw);
                            max-width: 90vw;
                            box-sizing: border-box;
                            pointer-events: auto;
                        }
                        .game-controls.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
                        .game-controls.preset-only { width: max(300px, 25vw); padding: 20px; }
                        .game-controls.front { z-index: 1002; }

                        @media (orientation: landscape) and (max-height: 600px) {
                            .game-controls { max-height: 85vh; overflow-y: auto; width: max(350px, 30vw); max-width: 70vw; }
                            .game-controls.preset-only { width: max(280px, 25vw); }
                            input, select { height: 40px !important; font-size: 14px !important; }
                            .upload-btn { width: 40px !important; height: 40px !important; }
                            .start-button.full-width { height: 50px !important; font-size: 16px !important; margin-top: 10px !important; }
                        }

                        input[type="text"], select {
                            width: 100%; height: 40px; padding: 0 12px;
                            background: rgba(255, 255, 255, 0.1);
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            border-radius: 6px; color: #fff;
                            font-family: monospace; font-size: 14px;
                            transition: all 0.3s; box-sizing: border-box;
                        }
                        input[type="text"]:focus { outline: none; border-color: #1AAFFF; background: rgba(255, 255, 255, 0.15); }
                        input[type="text"]::placeholder { color: rgba(255, 255, 255, 0.5); }

                        select {
                            cursor: pointer; appearance: none;
                            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                            background-repeat: no-repeat;
                            background-position: right 10px center;
                            background-size: 20px; padding-right: 40px;
                        }
                        select:disabled { background: rgba(128, 128, 128, 0.1); border-color: rgba(128, 128, 128, 0.2); color: #666; cursor: not-allowed; }
                        select:not(:disabled):hover { border-color: #1AAFFF; background-color: rgba(255, 255, 255, 0.15); }
                        select option { background: #333; color: #fff; font-size: 16px; }
                        @supports (-webkit-touch-callout: none) { select { font-size: 16px; } }

                        .filter-row {
                            grid-column: 1 / -1;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 10px;
                        }

                        .upload-btn, .start-button {
                            width: 40px; height: 40px; border-radius: 6px;
                            border: 2px solid rgba(255, 255, 255, 0.2);
                            background: rgba(255, 255, 255, 0.1); color: #fff;
                            font-size: 20px; cursor: pointer; transition: all 0.3s;
                            display: flex; align-items: center; justify-content: center;
                            padding: 0; flex-shrink: 0;
                        }
                        .upload-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); border-color: #1AAFFF; transform: scale(1.05); }

                        .start-button { background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); color: #4CAF50; font-weight: bold; }
                        .start-button.full-width { width: 100%; height: 45px; font-size: 16px; margin-top: 5px; padding-right: 24px; }
                        .start-button svg { flex-shrink: 0; margin-right: 6px; }
                        .start-button:not(:disabled):hover { background: rgba(76, 175, 80, 0.3); border-color: #4CAF50; color: #66BB6A; transform: scale(1.05); }
                        .start-button:disabled { background: rgba(128, 128, 128, 0.1); border-color: rgba(128, 128, 128, 0.2); color: #666; opacity: 0.6; cursor: not-allowed; }

                        .full-width { grid-column: 1 / -1; }
                        .or-separator { grid-column: 1 / -1; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px; padding: 5px 0; }

                        .preset-section {
                            display: contents;
                        }
                        .preset-section.hidden {
                            display: none;
                        }
                        .manual-config {
                            display: contents;
                        }
                        .manual-config.hidden {
                            display: none;
                        }
                        input[type="file"] { display: none; }
                        .connection-status { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); color: #ff9800; font-size: 14px; white-space: nowrap; }
                        .disabled-overlay { opacity: 0.5; }

                        .loading-overlay {
                            position: absolute; inset: 0;
                            background: rgba(0, 0, 0, 0.9);
                            display: none; align-items: center; justify-content: center;
                            flex-direction: column; border-radius: 8px; z-index: 10;
                        }
                        .loading-overlay.active { display: flex; }
                        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
                        @keyframes spin { to { transform: rotate(360deg); } }
                        .loading-text { color: #fff; margin-top: 20px; font-size: 16px; }
                        .cancel-button {
                            margin-top: 20px; padding: 10px 24px;
                            background: rgba(244, 67, 54, 0.2); border: 2px solid rgba(244, 67, 54, 0.4);
                            border-radius: 6px; color: #f44336; font-size: 14px; cursor: pointer;
                            transition: all 0.3s;
                        }
                        .cancel-button:hover { background: rgba(244, 67, 54, 0.3); border-color: #f44336; }

                        .refresh-button {
                            position: fixed;
                            top: 15px;
                            right: 15px;
                            width: 36px;
                            height: 36px;
                            border-radius: 6px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            color: rgba(255, 255, 255, 0.3);
                            cursor: pointer;
                            display: none;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s;
                            z-index: 100;
                            pointer-events: auto;
                        }
                        .refresh-button:hover {
                            background: rgba(255, 255, 255, 0.1);
                            border-color: rgba(255, 255, 255, 0.2);
                            color: rgba(255, 255, 255, 0.6);
                        }
                        .refresh-button svg {
                            width: 18px;
                            height: 18px;
                            fill: currentColor;
                        }
                        :host([mode="controller"]) .refresh-button { display: flex; }

                        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

                        .menu-header {
                            grid-column: 1 / -1;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding-bottom: 12px;
                            margin-bottom: 5px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                            position: relative;
                        }
                        .title-wrapper {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .title-icon {
                            font-size: 18px;
                            line-height: 1;
                        }
                        .menu-title {
                            font-family: 'Press Start 2P', monospace;
                            font-size: 14px;
                            font-weight: bold;
                            background: linear-gradient(
                                90deg,
                                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000
                            );
                            background-size: 200% 100%;
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            animation: rainbow-move 3s linear infinite, typewriter 2s steps(8) forwards;
                            text-transform: uppercase;
                            letter-spacing: 2px;
                            overflow: hidden;
                            white-space: nowrap;
                            width: 0;
                            border-right: 2px solid rgba(255, 255, 255, 0.7);
                        }
                        .menu-title.typed {
                            width: auto;
                            border-right: none;
                            animation: rainbow-move 3s linear infinite;
                        }
                        @keyframes rainbow-move {
                            0% { background-position: 0% 50%; }
                            100% { background-position: 200% 50%; }
                        }
                        @keyframes typewriter {
                            0% { width: 0; }
                            100% { width: 8ch; }
                        }
                        .debug-button {
                            position: absolute;
                            right: -5px;
                            top: -2px;
                            width: 24px;
                            height: 24px;
                            border-radius: 4px;
                            background: transparent;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            color: rgba(255, 255, 255, 0.25);
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s;
                            padding: 0;
                        }
                        .debug-button:hover {
                            background: rgba(255, 255, 255, 0.05);
                            border-color: rgba(255, 255, 255, 0.2);
                            color: rgba(255, 255, 255, 0.4);
                        }
                        .debug-button.active {
                            background: rgba(255, 255, 255, 0.1);
                            border-color: rgba(255, 255, 255, 0.3);
                            color: rgba(255, 255, 255, 0.6);
                        }
                        .debug-button svg {
                            width: 14px;
                            height: 14px;
                            fill: currentColor;
                        }

                        .settings-view {
                            display: none;
                            flex-direction: column;
                            gap: 16px;
                            grid-column: 1 / -1;
                            padding-top: 10px;
                        }
                        .settings-view.visible {
                            display: flex;
                        }
                        .game-selection-view.hidden {
                            display: none;
                        }
                        #gameSelectionView {
                            display: contents;
                        }
                        #gameSelectionView.hidden {
                            display: none;
                        }

                        .setting-row {
                            display: flex;
                            flex-direction: column;
                            gap: 8px;
                        }
                        .setting-label {
                            color: rgba(255, 255, 255, 0.7);
                            font-size: 13px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .setting-value {
                            color: rgba(255, 255, 255, 0.9);
                            font-family: monospace;
                            font-size: 12px;
                        }

                        .slider-container {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        input[type="range"] {
                            flex: 1;
                            height: 6px;
                            -webkit-appearance: none;
                            appearance: none;
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 3px;
                            outline: none;
                        }
                        input[type="range"]::-webkit-slider-thumb {
                            -webkit-appearance: none;
                            appearance: none;
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            background: #1AAFFF;
                            cursor: pointer;
                            transition: transform 0.2s;
                        }
                        input[type="range"]::-webkit-slider-thumb:hover {
                            transform: scale(1.1);
                        }
                        input[type="range"]::-moz-range-thumb {
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            background: #1AAFFF;
                            cursor: pointer;
                            border: none;
                        }

                        .toggle-switch {
                            position: relative;
                            width: 44px;
                            height: 24px;
                            flex-shrink: 0;
                        }
                        .toggle-switch input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }
                        .toggle-slider {
                            position: absolute;
                            cursor: pointer;
                            inset: 0;
                            background: rgba(255, 255, 255, 0.1);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            border-radius: 24px;
                            transition: all 0.3s;
                        }
                        .toggle-slider::before {
                            position: absolute;
                            content: "";
                            height: 18px;
                            width: 18px;
                            left: 2px;
                            bottom: 2px;
                            background: rgba(255, 255, 255, 0.5);
                            border-radius: 50%;
                            transition: all 0.3s;
                        }
                        .toggle-switch input:checked + .toggle-slider {
                            background: rgba(76, 175, 80, 0.3);
                            border-color: rgba(76, 175, 80, 0.5);
                        }
                        .toggle-switch input:checked + .toggle-slider::before {
                            transform: translateX(20px);
                            background: #4CAF50;
                        }

                        .toggle-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .toggle-info {
                            display: flex;
                            flex-direction: column;
                            gap: 2px;
                        }
                        .toggle-info .setting-label {
                            display: inline;
                        }
                        .toggle-description {
                            color: rgba(255, 255, 255, 0.4);
                            font-size: 11px;
                        }
                        .ejs-prefix {
                            color: #00CED1;
                            font-weight: bold;
                            font-size: 9px;
                            margin-left: 2px;
                        }
                        .setting-persisted .setting-label,
                        .setting-persisted .toggle-info .setting-label {
                            color: rgba(255, 235, 150, 0.85);
                        }

                        .player-status {
                            position: fixed;
                            top: calc(50% - 220px);
                            left: 50%;
                            transform: translateX(-50%);
                            display: flex;
                            gap: 8px;
                            align-items: center;
                            justify-content: center;
                            background: rgba(0, 0, 0, 0.7);
                            padding: 8px 16px;
                            border-radius: 8px;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            transition: opacity 0.3s, visibility 0.3s;
                            z-index: 1001;
                            pointer-events: auto;
                        }
                        .player-status.hidden {
                            opacity: 0;
                            visibility: hidden;
                            pointer-events: none;
                        }
                        .player-indicator {
                            display: flex;
                            align-items: center;
                            gap: 4px;
                            color: rgba(255, 255, 255, 0.4);
                            font-size: 11px;
                        }
                        .player-indicator.connected {
                            color: rgba(255, 255, 255, 0.9);
                        }
                        .player-indicator.connected .pip {
                            animation: pulse 2s ease-in-out infinite;
                        }
                        .player-indicator.reserved {
                            color: rgba(255, 255, 255, 0.5);
                        }
                        .player-indicator.reserved .pip {
                            opacity: 0.5;
                        }
                        .player-indicator .pip {
                            width: 10px;
                            height: 10px;
                            border-radius: 50%;
                            background: rgba(255, 255, 255, 0.15);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                        }
                        .player-indicator.connected .pip,
                        .player-indicator.reserved .pip {
                            border: none;
                        }
                        .player-indicator .pip.p0 { background: #4CAF50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.4); }
                        .player-indicator .pip.p1 { background: #2196F3; box-shadow: 0 0 6px rgba(33, 150, 243, 0.4); }
                        .player-indicator .pip.p2 { background: #9C27B0; box-shadow: 0 0 6px rgba(156, 39, 176, 0.4); }
                        .player-indicator .pip.p3 { background: #FFC107; box-shadow: 0 0 6px rgba(255, 193, 7, 0.4); }
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); opacity: 1; }
                            50% { transform: scale(1.15); opacity: 0.8; }
                        }
                    </style>

                    <div class="player-status" id="playerStatus">
                        <div class="player-indicator" data-player="0"><span class="pip"></span><span>P1</span></div>
                        <div class="player-indicator" data-player="1"><span class="pip"></span><span>P2</span></div>
                        <div class="player-indicator" data-player="2"><span class="pip"></span><span>P3</span></div>
                        <div class="player-indicator" data-player="3"><span class="pip"></span><span>P4</span></div>
                    </div>
                    <div class="game-controls" id="gameControls">
                        <div class="menu-header">
                            <div class="title-wrapper">
                                <span class="title-icon">üïπÔ∏è</span>
                                <span class="menu-title">RetroBox</span>
                            </div>
                            <button class="debug-button" id="debugButton" title="Settings">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                            </button>
                        </div>

                        <div id="gameSelectionView">
                            <div id="presetSection" class="preset-section">
                                <select id="allGamesSelect" class="full-width"><option value="">All Games</option></select>
                                <div class="or-separator">- or filter by -</div>
                                <div class="filter-row">
                                    <select id="coreSelect"><option value="">Console</option></select>
                                    <select id="playerCountSelect" disabled><option value="">Players</option></select>
                                </div>
                                <select id="gameSelect" class="full-width" disabled><option value="">Select Game</option></select>
                            </div>
                            <div id="manualConfigSection" class="manual-config hidden">
                                <input type="text" id="romUrlInput" placeholder="Enter ROM URL or upload file">
                                <button class="upload-btn" id="uploadButton">+</button>
                                <input type="text" id="biosUrlInput" placeholder="BIOS URL (optional)">
                                <button class="upload-btn" id="biosUploadButton">+</button>
                                <select id="consoleSelect" class="full-width"><option value="">Select Console</option></select>
                            </div>
                            <button class="start-button full-width" id="startButton" disabled><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Start</button>
                        </div>

                        <div class="settings-view" id="settingsView">
                            <div class="setting-row setting-persisted">
                                <div class="setting-label">
                                    <span>Game Height</span>
                                    <span class="setting-value" id="gameHeightValue">100%</span>
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="gameHeightSlider" min="50" max="100" value="100" step="5">
                                </div>
                            </div>

                            <div class="setting-row setting-persisted">
                                <div class="toggle-row">
                                    <div class="toggle-info">
                                        <span class="setting-label"><span>Threads<sup class="ejs-prefix">EJS</sup></span></span>
                                        <span class="toggle-description">Enable multi-threading (experimental)</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="threadsToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-row setting-persisted">
                                <div class="toggle-row">
                                    <div class="toggle-info">
                                        <span class="setting-label">Debug Logs</span>
                                        <span class="toggle-description">Buffer console logs for remote viewing</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="debugModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-row">
                                <div class="toggle-row">
                                    <div class="toggle-info">
                                        <span class="setting-label">Use URL</span>
                                        <span class="toggle-description">Load ROM from URL instead of presets</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="useUrlToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="loading-overlay" id="loadingOverlay">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading game...</div>
                            <button class="cancel-button" id="cancelButton">Cancel</button>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".zip,.7z,.nes,.smc,.sfc,.gb,.gba,.gbc,.n64,.z64,.nds,.pce,.ngp,.ngc,.ws,.wsc,.col,.cv,.d64">
                    <input type="file" id="biosFileInput" accept=".zip,.7z,.bin,.rom,.bios">
                    <button class="refresh-button" id="refreshButton" title="Refresh Screen & Controller">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </button>
                `;
            }

            async init() {
                // Core display names
                this.coreNames = {
                    psx: 'PlayStation',
                    snes: 'SNES',
                    arcade: 'Arcade',
                    n64: 'Nintendo 64',
                    segaMD: 'Sega MD',
                    nes: 'NES',
                    gb: 'Game Boy',
                    gba: 'GBA',
                    nds: 'Nintendo DS',
                };

                // All core values for manual console selection
                this.coreValues = {
                    "Nintendo 64": "n64", "Nintendo Game Boy": "gb", "Nintendo Game Boy Advance": "gba",
                    "Nintendo DS": "nds", "Nintendo Entertainment System": "nes", "Super Nintendo Entertainment System": "snes",
                    "PlayStation": "psx", "Virtual Boy": "vb", "Sega Mega Drive": "segaMD", "Sega Master System": "segaMS",
                    "Sega CD": "segaCD", "Atari Lynx": "lynx", "Sega 32X": "sega32x", "Atari Jaguar": "jaguar",
                    "Sega Game Gear": "segaGG", "Sega Saturn": "segaSaturn", "Atari 7800": "atari7800", "Atari 2600": "atari2600",
                    "Arcade": "arcade", "NEC TurboGrafx-16/SuperGrafx/PC Engine": "pce", "NEC PC-FX": "pcfx",
                    "SNK NeoGeo Pocket (Color)": "ngp", "Bandai WonderSwan (Color)": "ws", "ColecoVision": "coleco",
                    "Commodore 64": "vice_x64sc", "Commodore 128": "vice_x128", "Commodore VIC20": "vice_xvic",
                    "Commodore Plus/4": "vice_xplus4", "Commodore PET": "vice_xpet", "DOSBOX-PURE": "dosbox_pure"
                };

                // Fetch presets from API
                await this.loadPresets();

                this.populateSelectors();
                this.setupEventListeners();
                this.loadPersistedSettings();
                this.updateManualConfigVisibility();
                this.updateConnectionStatus();

                // Set default selection if presets loaded
                if (Object.keys(this.gamePresets).length > 0) {
                    // Default to Nintendo 64 if available, otherwise first core
                    const defaultCore = this.gamePresets['n64'] ? 'n64' : Object.keys(this.gamePresets)[0];
                    this.coreSelect.value = defaultCore;
                    this.updatePlayerCountOptions();
                    // Don't auto-select player count - show all games grouped
                    this.updateGameOptions();
                }
            }

            async loadPresets() {
                try {
                    const res = await fetch('/api/presets');
                    if (res.ok) {
                        this.gamePresets = await res.json();
                    }
                } catch (err) {
                    console.error('Failed to load presets:', err);
                    this.gamePresets = {};
                }
            }

            populateSelectors() {
                // Populate "All Games" dropdown with optgroups: "Core - Xp"
                const grouped = {};
                for (const [core, playerCounts] of Object.entries(this.gamePresets)) {
                    // Sort player counts descending
                    const sortedPCs = Object.keys(playerCounts).sort((a, b) => parseInt(b) - parseInt(a));
                    for (const pc of sortedPCs) {
                        const groupKey = `${core}|${pc}`;
                        grouped[groupKey] = playerCounts[pc]
                            .map(game => ({ ...game, core, playerCount: pc }))
                            .sort((a, b) => a.name.localeCompare(b.name));
                    }
                }
                // Sort group keys by core display name, then player count descending
                const sortedGroups = Object.keys(grouped).sort((a, b) => {
                    const [coreA, pcA] = a.split('|');
                    const [coreB, pcB] = b.split('|');
                    const coreCompare = (this.coreNames[coreA] || coreA).localeCompare(this.coreNames[coreB] || coreB);
                    if (coreCompare !== 0) return coreCompare;
                    return parseInt(pcB) - parseInt(pcA);
                });
                for (const groupKey of sortedGroups) {
                    const [core, pc] = groupKey.split('|');
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${this.coreNames[core] || core} - ${pc}`;
                    for (const game of grouped[groupKey]) {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ rom: game.rom, core: game.core, playerCount: game.playerCount });
                        opt.textContent = game.name;
                        optgroup.appendChild(opt);
                    }
                    this.allGamesSelect.appendChild(optgroup);
                }

                // Populate core dropdown with cores that have presets
                for (const core of Object.keys(this.gamePresets)) {
                    const opt = document.createElement('option');
                    opt.value = core;
                    opt.textContent = this.coreNames[core] || core;
                    this.coreSelect.appendChild(opt);
                }

                // Populate full console list for manual selection
                for (const [name, core] of Object.entries(this.coreValues)) {
                    const opt = document.createElement('option');
                    opt.value = core;
                    opt.textContent = name;
                    this.consoleSelect.appendChild(opt);
                }
            }

            updatePlayerCountOptions() {
                const core = this.coreSelect.value;
                this.playerCountSelect.innerHTML = '<option value="">Players</option>';

                if (core && this.gamePresets[core]) {
                    const playerCounts = Object.keys(this.gamePresets[core]).sort((a, b) => {
                        return parseInt(b) - parseInt(a); // Sort descending (4p, 3p, 2p)
                    });
                    for (const pc of playerCounts) {
                        const opt = document.createElement('option');
                        opt.value = pc;
                        opt.textContent = pc;
                        this.playerCountSelect.appendChild(opt);
                    }
                    this.playerCountSelect.disabled = false;
                    // Keep "Players" selected (empty value) and show all games
                    this.updateGameOptions();
                } else {
                    this.playerCountSelect.disabled = true;
                    this.gameSelect.innerHTML = '<option value="">Select Game</option>';
                    this.gameSelect.disabled = true;
                }
            }

            updateGameOptions() {
                const core = this.coreSelect.value;
                const playerCount = this.playerCountSelect.value;
                this.gameSelect.innerHTML = '<option value="">Select Game</option>';

                if (!core) {
                    this.gameSelect.disabled = true;
                    return;
                }

                if (!playerCount) {
                    // "Players" selected (empty) - show all games grouped by player count
                    const playerCounts = Object.keys(this.gamePresets[core]).sort((a, b) => {
                        return parseInt(b) - parseInt(a);
                    });
                    for (const pc of playerCounts) {
                        const games = this.gamePresets[core][pc];
                        if (!games?.length) continue;
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = pc;
                        for (const game of games.slice().sort((a, b) => a.name.localeCompare(b.name))) {
                            const opt = document.createElement('option');
                            opt.value = JSON.stringify({ rom: game.rom, playerCount: pc });
                            opt.textContent = game.name;
                            optgroup.appendChild(opt);
                        }
                        this.gameSelect.appendChild(optgroup);
                    }
                    this.gameSelect.disabled = false;
                } else if (this.gamePresets[core]?.[playerCount]) {
                    // Specific player count selected - show only those games
                    const games = this.gamePresets[core][playerCount];
                    for (const game of games.slice().sort((a, b) => a.name.localeCompare(b.name))) {
                        const opt = document.createElement('option');
                        opt.value = game.rom;
                        opt.textContent = game.name;
                        this.gameSelect.appendChild(opt);
                    }
                    this.gameSelect.disabled = false;
                } else {
                    this.gameSelect.disabled = true;
                }
            }

            setupEventListeners() {
                this.allGamesSelect.onchange = () => {
                    if (this.allGamesSelect.value) {
                        const { rom, core, playerCount } = JSON.parse(this.allGamesSelect.value);
                        // Update filtered dropdowns to match
                        this.coreSelect.value = core;
                        this.updatePlayerCountOptions();
                        this.playerCountSelect.value = playerCount;
                        this.updateGameOptions();
                        this.gameSelect.value = rom;
                        this.applySelectedGame();
                    } else {
                        this.clearManualInputs();
                    }
                    this.updateStartButtonState();
                };

                this.coreSelect.onchange = () => {
                    this.allGamesSelect.value = '';
                    this.updatePlayerCountOptions();
                    this.clearManualInputs();
                    this.updateStartButtonState();
                };

                this.playerCountSelect.onchange = () => {
                    this.allGamesSelect.value = '';
                    this.updateGameOptions();
                    this.clearManualInputs();
                    this.updateStartButtonState();
                };

                this.gameSelect.onchange = () => {
                    if (this.gameSelect.value) {
                        this.allGamesSelect.value = '';
                        this.applySelectedGame();
                    } else {
                        this._currentRomSource = this._currentParentRomSource = this._currentBiosSource = null;
                        this.romUrlInput.value = this.biosUrlInput.value = '';
                    }
                    this.updateStartButtonState();
                };

                this.uploadButton.onclick = () => this.fileInput.click();
                this.biosUploadButton.onclick = () => this.biosFileInput.click();

                this.fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    this._currentRomSource = file;
                    this._currentParentRomSource = null;
                    this._currentBiosSource = null;
                    this.romUrlInput.value = file.name;
                    this.biosUrlInput.value = '';
                    this.allGamesSelect.value = '';
                    this.coreSelect.value = '';
                    this.playerCountSelect.value = '';
                    this.playerCountSelect.disabled = true;
                    this.gameSelect.value = '';
                    this.gameSelect.disabled = true;
                    this.consoleSelect.value = '';
                    this.startButton.disabled = true;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const core = this.detectCore(ext);
                    if (core) {
                        this.consoleSelect.value = core;
                        this.updateStartButtonState();
                    }
                };

                this.biosFileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this._currentBiosSource = file;
                        this.biosUrlInput.value = file.name;
                    }
                };

                this.romUrlInput.oninput = (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        this._currentRomSource = url;
                        this._currentParentRomSource = null;
                        this._currentBiosSource = null;
                        this.biosUrlInput.value = '';
                        this.allGamesSelect.value = '';
                        this.coreSelect.value = '';
                        this.playerCountSelect.value = '';
                        this.playerCountSelect.disabled = true;
                        this.gameSelect.value = '';
                        this.gameSelect.disabled = true;
                        const ext = url.split('/').pop().split('?')[0].split('.').pop().toLowerCase();
                        const core = this.detectCore(ext);
                        if (core) this.consoleSelect.value = core;
                        this.consoleSelect.disabled = false;
                    } else {
                        this._currentRomSource = null;
                        this.consoleSelect.disabled = true;
                    }
                    this.updateStartButtonState();
                };

                this.biosUrlInput.oninput = (e) => {
                    this._currentBiosSource = e.target.value.trim() || null;
                };

                this.consoleSelect.onchange = () => this.updateStartButtonState();

                this.startButton.onclick = () => {
                    if (!this._currentRomSource || !this.consoleSelect.value) return;

                    const romName = typeof this._currentRomSource === 'string'
                        ? this._currentRomSource.split('/').pop().split('?')[0]
                        : this._currentRomSource.name;

                    const gameData = {
                        romSource: this._currentRomSource,
                        parentRomSource: this._currentParentRomSource,
                        biosSource: this._currentBiosSource,
                        core: this.consoleSelect.value,
                        romName,
                        gameHeight: this._currentGameHeight < 100 ? this._currentGameHeight : null,
                        threads: this._threads
                    };

                    this.showLoading();

                    if (this._mode === 'controller' && this._ws?.readyState === WebSocket.OPEN) {
                        if (this._currentRomSource instanceof File || this._currentBiosSource instanceof File) {
                            alert('File uploads not supported in controller mode. Use URLs or presets.');
                            this.hideLoading();
                            return;
                        }
                        this._ws.send(JSON.stringify({ type: 'startGame', gameData }));
                    } else {
                        this.dispatchEvent(new CustomEvent('gamestart', { detail: gameData, bubbles: true }));
                    }
                };

                this.cancelButton.onclick = () => {
                    if (this._mode === 'controller' && this._ws?.readyState === WebSocket.OPEN) {
                        this._ws.send(JSON.stringify({ type: 'resetToMenu' }));
                    } else {
                        this.dispatchEvent(new CustomEvent('resetToMenu', { bubbles: true }));
                    }
                    this.hideLoading();
                };

                this.refreshButton.onclick = () => {
                    if (this._ws?.readyState === WebSocket.OPEN) {
                        this._ws.send(JSON.stringify({ type: 'hardRefresh' }));
                    }
                    setTimeout(() => window.location.reload(), 500);
                };

                // Debug/Settings button
                this.debugButton.onclick = () => {
                    this._showingSettings = !this._showingSettings;
                    this.updateSettingsVisibility();
                };

                // Game height slider
                this.gameHeightSlider.oninput = (e) => {
                    const value = parseInt(e.target.value);
                    this._currentGameHeight = value;
                    this.gameHeightValue.textContent = value + '%';
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_gameHeight', value);
                    } else if (this._mode === 'controller') {
                        this.dispatchEvent(new CustomEvent('settingchange', { detail: { setting: 'gameHeight', value }, bubbles: true }));
                    }
                };

                // Threads toggle
                this.threadsToggle.onchange = (e) => {
                    this._threads = e.target.checked;
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_threads', e.target.checked);
                    } else if (this._mode === 'controller') {
                        this.dispatchEvent(new CustomEvent('settingchange', { detail: { setting: 'threads', value: e.target.checked }, bubbles: true }));
                    }
                };

                // Use URL toggle
                this.useUrlToggle.onchange = (e) => {
                    this._useUrl = e.target.checked;
                    this.updateManualConfigVisibility();
                };

                // Debug mode toggle
                this.debugModeToggle.onchange = (e) => {
                    this._debugMode = e.target.checked;
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_debugMode', e.target.checked);
                    } else if (this._mode === 'controller') {
                        this.dispatchEvent(new CustomEvent('settingchange', { detail: { setting: 'debugMode', value: e.target.checked }, bubbles: true }));
                    }
                    this.dispatchEvent(new CustomEvent('debugmodechange', { detail: { enabled: e.target.checked }, bubbles: true }));
                };
            }

            updateManualConfigVisibility() {
                if (this._useUrl) {
                    this.presetSection.classList.add('hidden');
                    this.manualConfigSection.classList.remove('hidden');
                    // Hide upload buttons on controller mode (file uploads not supported)
                    if (this._mode === 'controller') {
                        this.uploadButton.style.display = 'none';
                        this.biosUploadButton.style.display = 'none';
                    } else {
                        this.uploadButton.style.display = '';
                        this.biosUploadButton.style.display = '';
                    }
                } else {
                    this.presetSection.classList.remove('hidden');
                    this.manualConfigSection.classList.add('hidden');
                }
            }

            loadPersistedSettings() {
                if (this._mode !== 'screen') return;

                // Load game height
                const savedHeight = localStorage.getItem('retrobox_gameHeight');
                if (savedHeight !== null) {
                    const height = parseInt(savedHeight);
                    this._currentGameHeight = height;
                    this.gameHeightSlider.value = height;
                    this.gameHeightValue.textContent = height + '%';
                }

                // Load threads setting
                const savedThreads = localStorage.getItem('retrobox_threads');
                if (savedThreads !== null) {
                    this._threads = savedThreads === 'true';
                    this.threadsToggle.checked = this._threads;
                }

                // Load debug mode setting
                const savedDebugMode = localStorage.getItem('retrobox_debugMode');
                if (savedDebugMode !== null) {
                    this._debugMode = savedDebugMode === 'true';
                    this.debugModeToggle.checked = this._debugMode;
                    // Emit event so screen.html can start/stop buffering
                    this.dispatchEvent(new CustomEvent('debugmodechange', { detail: { enabled: this._debugMode }, bubbles: true }));
                }
            }

            // Apply setting from external source (e.g., controller via WebSocket)
            applySetting(setting, value) {
                if (setting === 'gameHeight') {
                    const height = parseInt(value);
                    this._currentGameHeight = height;
                    this.gameHeightSlider.value = height;
                    this.gameHeightValue.textContent = height + '%';
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_gameHeight', height);
                    }
                } else if (setting === 'threads') {
                    this._threads = value === true || value === 'true';
                    this.threadsToggle.checked = this._threads;
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_threads', this._threads);
                    }
                } else if (setting === 'debugMode') {
                    this._debugMode = value === true || value === 'true';
                    this.debugModeToggle.checked = this._debugMode;
                    if (this._mode === 'screen') {
                        localStorage.setItem('retrobox_debugMode', this._debugMode);
                    }
                    this.dispatchEvent(new CustomEvent('debugmodechange', { detail: { enabled: this._debugMode }, bubbles: true }));
                }
            }

            updateSettingsVisibility() {
                const gearIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>';
                const backIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>';

                if (this._showingSettings) {
                    this.gameSelectionView.classList.add('hidden');
                    this.settingsView.classList.add('visible');
                    this.debugButton.classList.add('active');
                    this.debugButton.innerHTML = backIcon;
                    this.debugButton.title = 'Back';
                } else {
                    this.gameSelectionView.classList.remove('hidden');
                    this.settingsView.classList.remove('visible');
                    this.debugButton.classList.remove('active');
                    this.debugButton.innerHTML = gearIcon;
                    this.debugButton.title = 'Settings';
                }
            }

            clearManualInputs() {
                this.romUrlInput.value = '';
                this.biosUrlInput.value = '';
                this._currentRomSource = null;
                this._currentParentRomSource = null;
                this._currentBiosSource = null;
            }

            applySelectedGame() {
                const core = this.coreSelect.value;
                const playerCount = this.playerCountSelect.value;
                const gameValue = this.gameSelect.value;

                if (!core || !gameValue) return;

                let romPath, actualPlayerCount;

                // When "Players" is selected (empty), value is JSON with rom and playerCount
                if (!playerCount) {
                    try {
                        const parsed = JSON.parse(gameValue);
                        romPath = parsed.rom;
                        actualPlayerCount = parsed.playerCount;
                    } catch {
                        return;
                    }
                } else {
                    romPath = gameValue;
                    actualPlayerCount = playerCount;
                }

                const games = this.gamePresets[core]?.[actualPlayerCount];
                const game = games?.find(g => g.rom === romPath);
                if (!game) return;

                this.romUrlInput.value = game.rom;
                this.biosUrlInput.value = game.bios || '';
                this._currentRomSource = game.rom;
                this._currentParentRomSource = game.parentRom || null;
                this._currentBiosSource = game.bios || null;
                this.consoleSelect.value = core;
                this.updateStartButtonState();
            }


            updateStartButtonState() {
                const hasRom = !!this._currentRomSource;
                const hasCore = !!this.consoleSelect.value;
                const connected = this._mode !== 'controller' || this._ws?.readyState === WebSocket.OPEN;
                this.startButton.disabled = !hasRom || !hasCore || !connected;
            }

            detectCore(ext) {
                const map = {
                    nes: 'nes', fds: 'nes', unif: 'nes', unf: 'nes',
                    smc: 'snes', fig: 'snes', sfc: 'snes', gd3: 'snes', gd7: 'snes', dx2: 'snes', bsx: 'snes', swc: 'snes',
                    z64: 'n64', n64: 'n64', pce: 'pce', ngp: 'ngp', ngc: 'ngp',
                    ws: 'ws', wsc: 'ws', col: 'coleco', cv: 'coleco', d64: 'vice_x64sc',
                    nds: 'nds', gba: 'gba', gb: 'gb'
                };
                return map[ext] || null;
            }

            hide() { this.container.classList.add('hidden'); this.hideLoading(); this.hidePlayerStatus(); }
            show() { this.container.classList.remove('hidden'); this.hideLoading(); this.showPlayerStatus(); }

            // Player status management
            // players: Map or object where key is playerNum (0-3), value is { connected: bool, reserved: bool }
            updatePlayerStatus(players) {
                this.playerIndicators.forEach((indicator, i) => {
                    const pip = indicator.querySelector('.pip');
                    const playerInfo = players?.get?.(i) || players?.[i];

                    indicator.classList.remove('connected', 'reserved');
                    pip.classList.remove('p0', 'p1', 'p2', 'p3');

                    if (playerInfo?.connected) {
                        indicator.classList.add('connected');
                        pip.classList.add(`p${i}`);
                    } else if (playerInfo?.reserved) {
                        indicator.classList.add('reserved');
                        pip.classList.add(`p${i}`);
                    }
                });
            }

            showPlayerStatus() { this.playerStatus?.classList.remove('hidden'); }
            hidePlayerStatus() { this.playerStatus?.classList.add('hidden'); }
            showLoading() { this.loadingOverlay?.classList.add('active'); }
            hideLoading() { this.loadingOverlay?.classList.remove('active'); }
            setLoadingText(text) {
                const el = this.shadowRoot.querySelector('.loading-text');
                if (el) el.textContent = text;
            }
            setWebSocket(ws) { this._ws = ws; this.updateConnectionStatus(); }
            setPeerConnection(conn) { this.setWebSocket(conn); }

            updateConnectionStatus() {
                if (this._mode !== 'controller') return;
                const connected = this._ws?.readyState === WebSocket.OPEN;
                this.coreSelect.disabled = !connected;
                this.playerCountSelect.disabled = !connected;
                this.gameSelect.disabled = !connected;
                this.romUrlInput.disabled = !connected;
                this.biosUrlInput.disabled = !connected;
                this.consoleSelect.disabled = !connected;
                this.gameHeightSlider.disabled = !connected;
                this.threadsToggle.disabled = !connected;
                this.updateStartButtonState();

                if (!connected) {
                    this.container.classList.add('disabled-overlay');
                    let msg = this.shadowRoot.querySelector('.connection-status');
                    if (!msg) {
                        msg = document.createElement('div');
                        msg.className = 'connection-status';
                        msg.textContent = 'Waiting for connection to screen...';
                        this.container.appendChild(msg);
                    }
                } else {
                    this.container.classList.remove('disabled-overlay');
                    this.shadowRoot.querySelector('.connection-status')?.remove();
                }
            }
        }

        customElements.define('game-menu', GameMenuElement);
    </script>
</body>
</html>
